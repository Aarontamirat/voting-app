// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// generator client {
//   provider = "prisma-client-js"
//   output   = "../app/generated/prisma"
// }

// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL")
// }

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Shareholder {
  id         String   @id
  name       String
  nameAm     String?
  phone      String?
  address    String?
  shareValue Decimal  @db.Decimal(30, 6) 
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  attendances   Attendance[]
  representedIn Representation[]
  shareholderID Representative[]
  nomineeID     Nominee[]

  @@index([name])
  @@index([phone])
}

model Meeting {
  id            String        @id @default(uuid())
  title         String
  date          DateTime
  location      String?
  quorumPct     Float? 
  status        MeetingStatus @default(DRAFT)
  firstPassers  Int?
  secondPassers Int?
  snapshotTotalShares Decimal?
  snapshotTotalHolders Int?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  attendances Attendance[]
  nominees    Nominee[]
  meeting     Representation[]
  meetings    Vote[]
}

enum MeetingStatus {
  DRAFT
  OPEN
  CLOSED
  VOTINGOPEN
}

model Representative {
  id            String       @id @default(uuid())
  name          String
  phone         String?
  // if this representative *is* a shareholder, link (optional)
  shareholderId String?
  shareholder   Shareholder? @relation(fields: [shareholderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  representations Representation[]
  representedBy   Attendance[]
}

model Representation {
  // Represents that `representative` represents `shareholder` for `meeting`
  id               Int    @id @default(autoincrement())
  meetingId        String
  representativeId String
  shareholderId    String

  meeting        Meeting        @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  representative Representative @relation(fields: [representativeId], references: [id], onDelete: Cascade)
  shareholder    Shareholder    @relation(fields: [shareholderId], references: [id], onDelete: Cascade)

  @@unique([meetingId, representativeId, shareholderId])
}

model Attendance {
  id                 String   @id @default(cuid())
  meetingId          String
  shareholderId      String
  representedById    String? // another shareholder
  representativeName String? // external rep

  // SNAPSHOT FIELDS
  snapshotName String
  snapshotNameAm String?
  snapshotPhone String?
  snapshotAddress String?
  snapshotShareValue Decimal @db.Decimal(30, 6)


  createdAt          DateTime @default(now())

  meeting       Meeting         @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  shareholder   Shareholder     @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
  representedBy Representative? @relation(fields: [representedById], references: [id], onDelete: Cascade)

  @@unique([meetingId, shareholderId]) // only one attendance row per shareholder per meeting
}

model Nominee {
  id            String   @id @default(cuid())
  name          String
  nameAm        String?
  type          String
  description   String?
  meetingId     String
  shareholderId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
  meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  votes       Vote[]
}

model Vote {
  id        String   @id @default(cuid())
  meetingId String
  nomineeId String
  voterId   String // shareholderId or representativeId
  weight    Float
  createdAt DateTime @default(now())

  // SNAPSHOT FIELDS
  snapshotVoterName String
  snapshotVoterShareValue Decimal @db.Decimal(30, 6)

  meetings Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  nominee  Nominee @relation(fields: [nomineeId], references: [id], onDelete: Cascade)

  @@unique([meetingId, nomineeId, voterId]) // a shareholder can vote at most once per nominee per meeting
}